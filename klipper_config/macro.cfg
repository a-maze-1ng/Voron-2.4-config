[gcode_macro QGL_READY]
gcode:
    G32
    NOZZLE_CLEAN_LOCATION

[gcode_macro POWER_OFF_PRINTER]
gcode:
  {action_call_remote_method("set_device_power",
                             device="printer",
                             state="off")}

[gcode_macro NOZZLE_CLEAN_LOCATION]
gcode:
    G90
    G1 X175 Y50 F20000
    G1 Z150 F8000

[gcode_macro LOAD_ABS]
gcode:
    SET_FILAMENT_SENSOR SENSOR=btt_sensor ENABLE=0 ;deactivate btt smart filament sensor
    M109 S240 ; heat and wait until extruder has 240C
    G91 ; use relative coordinates
    M83 ; use relative distances for extrusion
    ; small feeding steps for octoprint -> avoid timeout while paused printer
    G1 E25 F300 ; feed filament to hotend
    G1 E25 F300 ; feed filament to hotend
    G1 E25 F300 ; feed filament to hotend
    G1 E25 F300 ; feed filament to hotend
    G1 E25 F300 ; feed filament to hotend
    G90 ; use absolute coordinates
    M83 ; use relative distances for extrusion
    SET_FILAMENT_SENSOR SENSOR=btt_sensor ENABLE=1 ;deactivate btt smart filament sensor

[gcode_macro UNLOAD_ABS]
gcode:
    SET_FILAMENT_SENSOR SENSOR=btt_sensor ENABLE=0 ; deactivate btt smart filament sensor
    M109 S240 ; set hotend to 240C
    G91 ; use relative coordinates
    M83 ; use relative distances for extrusion
    G1 E10 F3200 ; push back the filament to smash any stringing
    G1 E-15 F3200 ; Extract back fast in the cold zone
    G1 E-30 F300 ; Continue extraction slowly, allow the filament time to cool solid before it reaches the gears
    G1 E-30 F300 ; Continue extraction slowly, allow the filament time to cool solid before it reaches the gears
    G1 E-30 F300 ; Continue extraction slowly, allow the filament time to cool solid before it reaches the gears
    G90 ; use absolute coordinates
    M83 ; use relative distances for extrusion
    SET_FILAMENT_SENSOR SENSOR=btt_sensor ENABLE=1 ; activate btt smart filament sensor

[gcode_macro LOAD_PLA]
gcode:
    SET_FILAMENT_SENSOR SENSOR=btt_sensor ENABLE=0 ;deactivate btt smart filament sensor
    M109 S210 ; heat and wait until extruder has 210C
    G91 ; use relative coordinates
    M83 ; use relative distances for extrusion
    ; small feeding steps for octoprint -> avoid timeout while paused printer
    G1 E25 F300 ; feed filament to hotend
    G1 E25 F300 ; feed filament to hotend
    G1 E25 F300 ; feed filament to hotend
    G1 E25 F300 ; feed filament to hotend
    G1 E25 F300 ; feed filament to hotend
    G90 ; use absolute coordinates
    M83 ; use relative distances for extrusion
    SET_FILAMENT_SENSOR SENSOR=btt_sensor ENABLE=1 ;deactivate btt smart filament sensor

[gcode_macro UNLOAD_PLA]
gcode:
    SET_FILAMENT_SENSOR SENSOR=btt_sensor ENABLE=0 ; deactivate btt smart filament sensor
    M109 S210 ; set hotend to 210C
    G91 ; use relative coordinates
    M83 ; use relative distances for extrusion
    G1 E10 F3200 ; push back the filament to smash any stringing
    G1 E-15 F3200 ; Extract back fast in the cold zone
    G1 E-30 F300 ; Continue extraction slowly, allow the filament time to cool solid before it reaches the gears
    G1 E-30 F300 ; Continue extraction slowly, allow the filament time to cool solid before it reaches the gears
    G1 E-30 F300 ; Continue extraction slowly, allow the filament time to cool solid before it reaches the gears
    G90 ; use absolute coordinates
    M83 ; use relative distances for extrusion
    SET_FILAMENT_SENSOR SENSOR=btt_sensor ENABLE=1 ; activate btt smart filament sensor

[gcode_macro WAIT_FOR_CHAMBER_TEMPERATURE]
#wait until the chamber sensor reach 47C
gcode:
	STATUS_HEATING
	TEMPERATURE_WAIT SENSOR="temperature_sensor chamber" MINIMUM=47

[gcode_macro PRINT_END_POS]
#if the Z position is below 150 move the head to front center, z = 150 mm
gcode:
	{% if printer.toolhead.position.z < 150 %}
		G90
		G1 X175 Y50 Z150 F2000
	{% endif %}
	{% if printer.toolhead.position.z >= 150 %}
		G90
		G1 X175 Y50 F2000
	{% endif %}
	STATUS_READY

[gcode_macro DO_PID_TUNE_EXTRUDER]
#small macro for PID tuning the hotend
gcode:
	{% set PID_TEMP = params.PID_TEMP|default(200)|float %}
	M106 S255 ;part cooling fan 100%
	PID_CALIBRATE HEATER=extruder TARGET={PID_TEMP}
	SAVE_CONFIG

[gcode_macro PREPARE_FOR_INPUT_SHAPING]
#small macro for input shaping
gcode:
	G32 ;home all axis and do a QGL
	G90 ;absolut reference
	G1 X175 Y175 Z50 F2000 ;extruder position in the middle of the printer
	M106 S0 ;turn off part cooling fan

[gcode_macro PREPARE_FOR_AUTO_Z_CALIBRATION]
#small macro for setup the auto z calibration
gcode:
	G32 ;home all axis and do a QGL
	STATUS_CALIBRATING_Z ;SB LED
	CALIBRATE_Z ;auto calibrate Z
	G90 ;absolut reference
	G1 X175 Y175 Z5 F2000 ;extruder position in the middle of the printer
	M106 S0 ;turn off part cooling fan

[gcode_macro PRINT_PRIME_LINE]
#print prime line
gcode:
	STATUS_PRINTING
	G92 E0 ;Reset Extruder
	G1 X5.1 Y200 Z0.28 F5000 ;Move to start position
	G1 X5.1 Y200.0 Z0.28 F1500 E0.000
	G1 X7.1 Y200.0 Z0.28 F1500 E0.154
	G1 X7.1 Y198.0 Z0.28 F1500 E0.308
	G1 X5.1 Y198.0 Z0.28 F1500 E0.462
	G1 X5.1 Y196.0 Z0.28 F1500 E0.616
	G1 X7.1 Y196.0 Z0.28 F1500 E0.770
	G1 X7.1 Y194.0 Z0.28 F1500 E0.924
	G1 X5.1 Y194.0 Z0.28 F1500 E1.077
	G1 X5.1 Y192.0 Z0.28 F1500 E1.231
	G1 X7.1 Y192.0 Z0.28 F1500 E1.385
	G1 X7.1 Y190.0 Z0.28 F1500 E1.539
	G1 X5.1 Y190.0 Z0.28 F1500 E1.693
	G1 X5.1 Y188.0 Z0.28 F1500 E1.847
	G1 X7.1 Y188.0 Z0.28 F1500 E2.001
	G1 X7.1 Y186.0 Z0.28 F1500 E2.155
	G1 X5.1 Y186.0 Z0.28 F1500 E2.309
	G1 X5.1 Y184.0 Z0.28 F1500 E2.463
	G1 X7.1 Y184.0 Z0.28 F1500 E2.617
	G1 X7.1 Y182.0 Z0.28 F1500 E2.771
	G1 X5.1 Y182.0 Z0.28 F1500 E2.925
	G1 X5.1 Y180.0 Z0.28 F1500 E3.079
	G1 X7.1 Y180.0 Z0.28 F1500 E3.232
	G1 X7.1 Y178.0 Z0.28 F1500 E3.386
	G1 X5.1 Y178.0 Z0.28 F1500 E3.540
	G1 X5.1 Y176.0 Z0.28 F1500 E3.694
	G1 X7.1 Y176.0 Z0.28 F1500 E3.848
	G1 X7.1 Y174.0 Z0.28 F1500 E4.002
	G1 X5.1 Y174.0 Z0.28 F1500 E4.156
	G1 X5.1 Y172.0 Z0.28 F1500 E4.310
	G1 X7.1 Y172.0 Z0.28 F1500 E4.464
	G1 X7.1 Y170.0 Z0.28 F1500 E4.618
	G1 X5.1 Y170.0 Z0.28 F1500 E4.772
	G1 X5.1 Y168.0 Z0.28 F1500 E4.926
	G1 X7.1 Y168.0 Z0.28 F1500 E5.080
	G1 X7.1 Y166.0 Z0.28 F1500 E5.233
	G1 X5.1 Y166.0 Z0.28 F1500 E5.387
	G1 X5.1 Y164.0 Z0.28 F1500 E5.541
	G1 X7.1 Y164.0 Z0.28 F1500 E5.695
	G1 X7.1 Y162.0 Z0.28 F1500 E5.849
	G1 X5.1 Y162.0 Z0.28 F1500 E6.003
	G1 X5.1 Y160.0 Z0.28 F1500 E6.157
	G1 X7.1 Y160.0 Z0.28 F1500 E6.311
	G1 X7.1 Y158.0 Z0.28 F1500 E6.465
	G1 X5.1 Y158.0 Z0.28 F1500 E6.619
	G1 X5.1 Y156.0 Z0.28 F1500 E6.773
	G1 X7.1 Y156.0 Z0.28 F1500 E6.927
	G1 X7.1 Y154.0 Z0.28 F1500 E7.081
	G1 X5.1 Y154.0 Z0.28 F1500 E7.234
	G1 X5.1 Y152.0 Z0.28 F1500 E7.388
	G1 X7.1 Y152.0 Z0.28 F1500 E7.542
	G1 X7.1 Y150.0 Z0.28 F1500 E7.696
	G1 X5.1 Y150.0 Z0.28 F1500 E7.850
	G1 X5.1 Y148.0 Z0.28 F1500 E8.004
	G1 X7.1 Y148.0 Z0.28 F1500 E8.158
	G1 X7.1 Y146.0 Z0.28 F1500 E8.312
	G1 X5.1 Y146.0 Z0.28 F1500 E8.466
	G1 X5.1 Y144.0 Z0.28 F1500 E8.620
	G1 X7.1 Y144.0 Z0.28 F1500 E8.774
	G1 X7.1 Y142.0 Z0.28 F1500 E8.928
	G1 X5.1 Y142.0 Z0.28 F1500 E9.082
	G1 X5.1 Y140.0 Z0.28 F1500 E9.236
	G1 X7.1 Y140.0 Z0.28 F1500 E9.389
	G1 X7.1 Y138.0 Z0.28 F1500 E9.543
	G1 X5.1 Y138.0 Z0.28 F1500 E9.697
	G1 X5.1 Y136.0 Z0.28 F1500 E9.851
	G1 X7.1 Y136.0 Z0.28 F1500 E10.005
	G1 X7.1 Y134.0 Z0.28 F1500 E10.159
	G1 X5.1 Y134.0 Z0.28 F1500 E10.313
	G1 X5.1 Y132.0 Z0.28 F1500 E10.467
	G1 X7.1 Y132.0 Z0.28 F1500 E10.621
	G1 X7.1 Y130.0 Z0.28 F1500 E10.775
	G1 X5.1 Y130.0 Z0.28 F1500 E10.929
	G1 X5.1 Y128.0 Z0.28 F1500 E11.083
	G1 X7.1 Y128.0 Z0.28 F1500 E11.237
	G1 X7.1 Y126.0 Z0.28 F1500 E11.390
	G1 X5.1 Y126.0 Z0.28 F1500 E11.544
	G1 X5.1 Y124.0 Z0.28 F1500 E11.698
	G1 X7.1 Y124.0 Z0.28 F1500 E11.852
	G1 X7.1 Y122.0 Z0.28 F1500 E12.006
	G1 X5.1 Y122.0 Z0.28 F1500 E12.160
	G1 X5.1 Y120.0 Z0.28 F1500 E12.314
	G1 X7.1 Y120.0 Z0.28 F1500 E12.468
	G1 X7.1 Y118.0 Z0.28 F1500 E12.622
	G1 X5.1 Y118.0 Z0.28 F1500 E12.776
	G1 X5.1 Y116.0 Z0.28 F1500 E12.930
	G1 X7.1 Y116.0 Z0.28 F1500 E13.084
	G1 X7.1 Y114.0 Z0.28 F1500 E13.238
	G1 X5.1 Y114.0 Z0.28 F1500 E13.391
	G1 X5.1 Y112.0 Z0.28 F1500 E13.545
	G1 X7.1 Y112.0 Z0.28 F1500 E13.699
	G1 X7.1 Y110.0 Z0.28 F1500 E13.853
	G1 X5.1 Y110.0 Z0.28 F1500 E14.007
	G1 X5.1 Y108.0 Z0.28 F1500 E14.161
	G1 X7.1 Y108.0 Z0.28 F1500 E14.315
	G1 X7.1 Y106.0 Z0.28 F1500 E14.469
	G1 X5.1 Y106.0 Z0.28 F1500 E14.623
	G1 X5.1 Y104.0 Z0.28 F1500 E14.777
	G1 X7.1 Y104.0 Z0.28 F1500 E14.931
	G1 X7.1 Y102.0 Z0.28 F1500 E15.085
	G1 X5.1 Y102.0 Z0.28 F1500 E15.239
	G1 X5.1 Y100.0 Z0.28 F1500 E15.393
	G1 X7.1 Y100.0 Z0.28 F1500 E15.546
	G1 X7.1 Y98.0 Z0.28 F1500 E15.700
	G1 X5.1 Y98.0 Z0.28 F1500 E15.854
	G1 X5.1 Y96.0 Z0.28 F1500 E16.008
	G1 X7.1 Y96.0 Z0.28 F1500 E16.162
	G1 X7.1 Y94.0 Z0.28 F1500 E16.316
	G1 X5.1 Y94.0 Z0.28 F1500 E16.470
	G1 X5.1 Y92.0 Z0.28 F1500 E16.624
	G1 X7.1 Y92.0 Z0.28 F1500 E16.778
	G1 X7.1 Y90.0 Z0.28 F1500 E16.932
	G1 X5.1 Y90.0 Z0.28 F1500 E17.086
	G1 X5.1 Y88.0 Z0.28 F1500 E17.240
	G1 X7.1 Y88.0 Z0.28 F1500 E17.394
	G1 X7.1 Y86.0 Z0.28 F1500 E17.547
	G1 X5.1 Y86.0 Z0.28 F1500 E17.701
	G1 X5.1 Y84.0 Z0.28 F1500 E17.855
	G1 X7.1 Y84.0 Z0.28 F1500 E18.009
	G1 X7.1 Y82.0 Z0.28 F1500 E18.163
	G1 X5.1 Y82.0 Z0.28 F1500 E18.317
	G1 X5.1 Y80.0 Z0.28 F1500 E18.471
	G1 X7.1 Y80.0 Z0.28 F1500 E18.625
	G1 X7.1 Y78.0 Z0.28 F1500 E18.779
	G1 X5.1 Y78.0 Z0.28 F1500 E18.933
	G1 X5.1 Y76.0 Z0.28 F1500 E19.087
	G1 X7.1 Y76.0 Z0.28 F1500 E19.241
	G1 X7.1 Y74.0 Z0.28 F1500 E19.395
	G1 X5.1 Y74.0 Z0.28 F1500 E19.548
	G1 X5.1 Y72.0 Z0.28 F1500 E19.702
	G1 X7.1 Y72.0 Z0.28 F1500 E19.856
	G1 X7.1 Y70.0 Z0.28 F1500 E20.010
	G1 X5.1 Y70.0 Z0.28 F1500 E20.164
	G1 X5.1 Y68.0 Z0.28 F1500 E20.318
	G1 X7.1 Y68.0 Z0.28 F1500 E20.472
	G1 X7.1 Y66.0 Z0.28 F1500 E20.626
	G1 X5.1 Y66.0 Z0.28 F1500 E20.780	
	G1 X5.1 Y64.0 Z0.28 F1500 E20.934
	G1 X7.1 Y64.0 Z0.28 F1500 E21.088
	G1 X7.1 Y62.0 Z0.28 F1500 E21.242
	G1 X5.1 Y62.0 Z0.28 F1500 E21.396
	G1 X5.1 Y60.0 Z0.28 F1500 E21.550
	G1 X7.1 Y60.0 Z0.28 F1500 E21.703
	G1 X7.1 Y58.0 Z0.28 F1500 E21.857
	G1 X5.1 Y58.0 Z0.28 F1500 E22.011
	G1 X5.1 Y56.0 Z0.28 F1500 E22.165
	G1 X7.1 Y56.0 Z0.28 F1500 E22.319
	G1 X7.1 Y54.0 Z0.28 F1500 E22.473
	G1 X5.1 Y54.0 Z0.28 F1500 E22.627
	G1 X5.1 Y52.0 Z0.28 F1500 E22.781
	G1 X7.1 Y52.0 Z0.28 F1500 E22.935
	G1 X7.1 Y50.0 Z0.28 F1500 E23.089
	G1 X5.1 Y50.0 Z0.28 F1500 E23.243
	G1 X5.1 Y48.0 Z0.28 F1500 E23.397
	G1 X7.1 Y48.0 Z0.28 F1500 E23.551
	G1 X7.1 Y46.0 Z0.28 F1500 E23.704
	G1 X5.1 Y46.0 Z0.28 F1500 E23.858
	G1 X5.1 Y44.0 Z0.28 F1500 E24.012
	G1 X7.1 Y44.0 Z0.28 F1500 E24.166
	G1 X7.1 Y42.0 Z0.28 F1500 E24.320
	G1 X5.1 Y42.0 Z0.28 F1500 E24.474
	G1 X5.1 Y40.0 Z0.28 F1500 E24.628
	G1 X7.1 Y40.0 Z0.28 F1500 E24.782
	G1 X7.1 Y38.0 Z0.28 F1500 E24.936
	G1 X5.1 Y38.0 Z0.28 F1500 E25.090
	G1 X5.1 Y36.0 Z0.28 F1500 E25.244
	G1 X7.1 Y36.0 Z0.28 F1500 E25.398
	G1 X7.1 Y34.0 Z0.28 F1500 E25.552
	G1 X5.1 Y34.0 Z0.28 F1500 E25.705
	G1 X5.1 Y32.0 Z0.28 F1500 E25.859
	G1 X7.1 Y32.0 Z0.28 F1500 E26.013
	G1 X7.1 Y30.0 Z0.28 F1500 E26.167
	G1 X5.1 Y30.0 Z0.28 F1500 E26.321
	G92 E0 ;Reset Extruder
	G1 Z2.0 F3000.0 ;Move Z Axis up